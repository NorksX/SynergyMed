<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>SynergyMed – Кошничка</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:replace="fragments/header :: headerStyles"></th:block>
    <style>
        :root{ --teal-1:#20b2aa; --teal-2:#48d1cc; --muted:#6c757d; }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;min-height:100vh;
            background:linear-gradient(135deg,#a4ecba 0%,#fefeff 100%);color:#1f2937}
        .site-header{position:sticky;top:0;left:0;right:0;width:100%;border-radius:0;margin:0;z-index:1000;background:white !important;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        .cart-container{max-width:1000px;margin:28px auto;padding:20px;background:white;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,0.1)}
        .cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .cart-item{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid #eee}
        .thumb{width:100px;height:80px;object-fit:cover;border-radius:10px;margin-right:18px}
        .cart-info{flex:1}
        .cart-title{font-weight:700;font-size:1.1rem}
        .cart-qty{display:flex;align-items:center;gap:10px;margin-top:8px}
        .btn-outline{background:#fff;border:2px solid rgba(32,178,170,.25);color:#20b2aa;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:600;transition:.2s ease}
        .btn-outline:hover{border-color:#20b2aa;box-shadow:0 6px 14px rgba(32,178,170,.18)}
        .btn-outline.is-disabled{opacity:.5;cursor:not-allowed;box-shadow:none;border-color:rgba(32,178,170,.18)}
        .btn-remove{color:#b3261e;border-color:#f0caca}
        .qty-badge{
            min-width:34px; text-align:center; font-weight:700;
            border:2px solid rgba(32,178,170,.25); border-radius:8px; padding:6px 10px; background:#fff; color:#20b2aa
        }
        .cart-total{text-align:right;margin-top:20px;font-size:1.4rem;font-weight:700}
        .btn-checkout{margin-top:20px;display:inline-block;background:linear-gradient(135deg,#20b2aa,#48d1cc);color:#fff;padding:12px 20px;border-radius:12px;text-decoration:none;font-weight:600;transition:.2s ease}
        .btn-checkout:hover{transform:translateY(-2px)}
        .loyalty{margin-top:12px;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb}
        .loyalty h4{margin:0 0 6px 0}
        .muted{color:#6c757d}
    </style>
</head>
<body>
<th:block th:replace="fragments/header :: siteHeader('cart')"></th:block>

<div class="cart-container">
    <div class="cart-header">
        <h2>Вашата Кошничка</h2>
        <a th:href="@{/catalog}" class="btn-outline">← Продолжете со пазарење</a>
    </div>

    <!-- Empty state for Map items -->
    <div th:if="${items == null or #maps.isEmpty(items)}">
        <p>Вашата кошничка е празна.</p>
    </div>

    <div th:each="entry : ${items}" class="cart-item">
        <img class="thumb"
             th:if="${firstImageById != null and firstImageById.containsKey(entry.key.id)}"
             th:src="@{${firstImageById[entry.key.id]}}"
             alt="лек">
        <img class="thumb"
             th:unless="${firstImageById != null and firstImageById.containsKey(entry.key.id)}"
             src="/images/default-medicine.png"
             alt="лек">

        <div class="cart-info">
            <div class="cart-title" th:text="${entry.key.name}">Лек</div>
            <div class="muted" th:text="${entry.key.dosageForm}">Форма</div>

            <!-- Quantity controls -->
            <div class="cart-qty">
                <form th:action="@{/cart/minus/{id}(id=${entry.key.id})}" method="post" style="display:inline">
                    <button type="submit"
                            class="btn-outline"
                            th:classappend="${entry.value <= 1} ? ' is-disabled'"
                            th:disabled="${entry.value <= 1}"
                            aria-label="Намали количина">−</button>
                </form>

                <!-- Live quantity between − and ＋ -->
                <span class="qty-badge" th:text="${entry.value}">1</span>

                <form th:action="@{/cart/plus/{id}(id=${entry.key.id})}" method="post" style="display:inline">
                    <button type="submit" class="btn-outline" aria-label="Зголеми количина">＋</button>
                </form>

                <form th:action="@{/cart/remove/{id}(id=${entry.key.id})}" method="post" style="display:inline">
                    <button type="submit" class="btn-outline btn-remove">Одстрани</button>
                </form>
            </div>
        </div>

        <div th:text="${#numbers.formatDecimal(entry.key.price * entry.value, 1, 'COMMA', 2, 'POINT') + ' ден.'}">0 ден.</div>
    </div>

    <!-- Loyalty card -->
    <div class="loyalty" th:if="${clubCard != null}">
        <h4>Клуб картичка</h4>
        <div class="muted">
            Програма: <span th:text="${clubCard.clubProgram}">Стандардна програма</span> •
            Поени: <span id="cardPoints" th:text="${clubCard.points}">0</span>
        </div>
        <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
            <input type="checkbox" id="usePointsChk">
            <span>Искористете поени (−1 денар за секои 2 поени)</span>
        </label>
        <div class="muted" id="pointsNote" style="margin-top:6px;"></div>
    </div>

    <!-- Totals only when Map has entries -->
    <div class="cart-total" th:if="${items != null and !#maps.isEmpty(items)}">
        Вкупно:
        <span id="totalValue"
              th:data-basetotal="${total.intValue()}"
              th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 2, 'POINT') + ' ден.'}">0.00 ден.</span>
        <div class="muted" id="discountLine" style="display:none;">Попуст: <span id="discountValue">0</span> ден.</div>
    </div>

    <!-- Hide checkout when cart is empty (items is a Map) -->
    <a class="btn-checkout" id="proceedLink"
       th:href="@{/payment}"
       th:if="${items != null and !#maps.isEmpty(items)}">Продолжете кон плаќање</a>
</div>

<th:block th:replace="fragments/header :: headerScripts"></th:block>
<script>
    (function(){
        const chk = document.getElementById('usePointsChk');
        const totalEl = document.getElementById('totalValue');
        const discountLine = document.getElementById('discountLine');
        const discountValue = document.getElementById('discountValue');
        const pointsEl = document.getElementById('cardPoints');
        const proceed = document.getElementById('proceedLink');
        const baseHref = proceed ? (proceed.getAttribute('href') || '/payment') : '/payment';
        if (!totalEl) return;

        const baseTotal = parseInt(totalEl.getAttribute('data-basetotal') || '0', 10);

        function recompute(){
            const pts = parseInt(pointsEl ? pointsEl.textContent : '0', 10);
            const maxDiscount = Math.floor(pts / 2); // 1 ден. per 2 points
            const apply = !!(chk && chk.checked);
            const applied = apply ? Math.min(maxDiscount, baseTotal) : 0;
            const newTotal = Math.max(0, baseTotal - applied);

            totalEl.textContent = newTotal.toFixed(2) + ' ден.';
            if (discountLine) discountLine.style.display = applied > 0 ? 'block' : 'none';
            if (discountValue) discountValue.textContent = applied.toString();

            if (proceed) {
                proceed.setAttribute('href', apply ? (baseHref + '?useCard=true') : baseHref);
            }

            const note = document.getElementById('pointsNote');
            if (note) note.textContent = 'Достапен попуст: ' + maxDiscount + ' ден. (од ' + pts + ' поени)';
        }

        if (chk) chk.addEventListener('change', recompute);
        recompute();
    })();
</script>
</body>
</html>
