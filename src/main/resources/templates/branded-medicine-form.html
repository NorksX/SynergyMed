<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${mode=='create' ? 'Create Branded Medicine' : 'Edit Branded Medicine'}">Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{
            --teal-1:#20b2aa;--teal-2:#48d1cc;--bg:#fefeff;--card:#ffffff;--muted:#6c757d;
            --shadow:0 20px 40px rgba(0,0,0,.1);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height:100vh; display:flex; align-items:flex-start; justify-content:center;
            background:linear-gradient(135deg,#a4ecba 0%,#fefeff 100%); padding:24px;
        }
        .wrap{width:100%; max-width:900px; background:#fff; border-radius:20px; overflow:hidden; box-shadow:var(--shadow)}
        .head{background:linear-gradient(135deg,var(--teal-1),var(--teal-2)); color:#fff; padding:26px 24px}
        .body{padding:26px 24px}
        .row{display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px}
        .row-1{display:grid; grid-template-columns:1fr; gap:16px; margin-bottom:6px}
        label{display:block; margin-bottom:8px; color:#334155; font-weight:600; font-size:.95rem}
        input,select,textarea{
            width:100%; padding:14px 12px; border:2px solid #e6ebf0; border-radius:12px; background:#f8fafc;
            transition:.2s ease; font-size:1rem
        }
        textarea{min-height:110px}
        input:focus,select:focus,textarea:focus{outline:none; border-color:var(--teal-1); background:#fff; box-shadow:0 0 0 3px rgba(32,178,170,.12)}
        .hint{color:var(--muted); font-size:.86rem; margin-top:4px}
        .section-title{margin:24px 0 10px; font-weight:800; color:#334155}
        .actions{display:flex; gap:12px; padding-top:12px; flex-wrap:wrap}
        .btn{border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; letter-spacing:.4px}
        .btn-primary{background:linear-gradient(135deg,var(--teal-1),var(--teal-2)); color:#fff; box-shadow:0 10px 20px rgba(32,178,170,.25)}
        .btn-secondary{background:#fff; color:#111; border:2px solid rgba(32,178,170,.25)}
        .btn-upload{background:#fff; color:#20b2aa; border:2px dashed rgba(32,178,170,.45)}
        .btn:hover{transform:translateY(-1px)}

        /* Gallery (separate from main form to avoid nested forms) */
        .gallery{ padding:0 24px 24px 24px; }
        .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); gap:12px; }
        .img-card{ position:relative; background:#f8fafc; border:1px solid #e6ebf0; border-radius:12px; padding:8px; }
        .thumb{ width:100%; height:110px; object-fit:cover; border-radius:8px; display:block; }
        .chip{ margin-top:8px; color:#20b2aa; font-weight:700; text-align:center; }
        .icon-btn{
            background:#fff; border:1px solid #e5e7eb; border-radius:50%; width:28px; height:28px;
            cursor:pointer; line-height:26px; text-align:center; font-weight:700;
        }
        .small-btn{
            background:#fff; border:2px solid rgba(32,178,170,.25); color:#20b2aa;
            padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600;
        }
        @media (max-width:720px){ .row{grid-template-columns:1fr} }
    </style>
</head>
<body>
<div class="wrap">
    <div class="head">
        <h2 th:text="${mode=='create' ? 'Create Branded Medicine' : 'Edit Branded Medicine'}">Form</h2>
    </div>

    <div class="body">
        <!-- CREATE MODE: one form, two submit targets using formaction -->
        <form th:if="${mode=='create'}"
              th:action="@{/branded-medicines}"  <!-- default for the 'Create' button -->
        method="post" enctype="multipart/form-data">

        <div class="row">
            <div>
                <label>Manufacturer</label>
                <select name="manufacturerId" required>
                    <option value="" disabled selected>Select manufacturer</option>
                    <option th:each="m : ${manufacturers}" th:value="${m.id}" th:text="${m.company.companyName}">Manufacturer</option>
                </select>
                <div class="hint">Pick the company that manufactured this medicine.</div>
            </div>
            <div>
                <label>Price</label>
                <input type="number" step="0.01" name="price" required/>
            </div>
        </div>

        <div class="row">
            <div>
                <label>Dosage Form</label>
                <input type="text" name="dosageForm" required/>
            </div>
            <div>
                <label>Strength</label>
                <input type="text" name="strength" required/>
            </div>
        </div>

        <div class="row">
            <div>
                <label>Origin Country</label>
                <input type="text" name="originCountry"/>
            </div>
            <div>
                <label>Name</label>
                <input type="text" name="name" required/>
            </div>
        </div>

        <div class="row-1">
            <div>
                <label>Description</label>
                <textarea name="description"></textarea>
            </div>
            <div>
                <label>Images</label>
                <input type="file" name="images" multiple accept="image/*"/>
                <div class="hint">PNG, JPG, GIF, WEBP up to 5MB each. Uploaded files are saved with the record.</div>
            </div>
        </div>

        <div class="actions">
            <!-- Upload (create the record with images, then stay on edit to choose main) -->
            <button class="btn btn-upload" type="submit"
                    th:formaction="@{/branded-medicines/create-and-stay}">
                Upload
            </button>

            <!-- Create (create with images and return home) -->
            <button class="btn btn-primary" type="submit">
                Create
            </button>

            <a class="btn btn-secondary" th:href="@{/}">Cancel</a>
        </div>
        </form>

        <!-- EDIT MODE: update fields and exit to home -->
        <form th:if="${mode=='edit'}"
              th:action="@{/branded-medicines/{id}/update-and-exit(id=${bm.id})}"
              method="post" enctype="multipart/form-data">

            <div class="row">
                <div>
                    <label>Manufacturer</label>
                    <select name="manufacturerId" required>
                        <option th:each="m : ${manufacturers}"
                                th:value="${m.id}"
                                th:text="${m.company.companyName}"
                                th:selected="${bm != null and bm.manufacturer != null and m.id == bm.manufacturer.id}">
                            Manufacturer
                        </option>
                    </select>
                    <div class="hint">Pick the company that manufactured this medicine.</div>
                </div>
                <div>
                    <label>Price</label>
                    <input type="number" step="0.01" name="price" th:value="${bm.price}" required/>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Dosage Form</label>
                    <input type="text" name="dosageForm" th:value="${bm.dosageForm}" required/>
                </div>
                <div>
                    <label>Strength</label>
                    <input type="text" name="strength" th:value="${bm.strength}" required/>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Origin Country</label>
                    <input type="text" name="originCountry" th:value="${bm.originCountry}"/>
                </div>
                <div>
                    <label>Name</label>
                    <input type="text" name="name" th:value="${bm.name}" required/>
                </div>
            </div>

            <div class="row-1">
                <div>
                    <label>Description</label>
                    <textarea name="description" th:text="${bm.description}"></textarea>
                </div>
                <div>
                    <label>Append Images</label>
                    <input type="file" name="images" multiple accept="image/*"/>
                    <div class="hint">Newly selected images will be appended and saved on Update.</div>
                </div>
            </div>

            <div class="actions">
                <!-- Update (save fields and images, then go home) -->
                <button class="btn btn-primary" type="submit"
                        th:formaction="@{/branded-medicines/{id}/update(id=${bm.id})}">
                    Update
                </button>

                <!-- Update & Exit (save fields only, exit) -->
                <button class="btn btn-secondary" type="submit">
                    Update & Exit
                </button>

                <a class="btn btn-secondary" th:href="@{/}">Cancel</a>
            </div>
        </form>
    </div>

    <!-- IMAGE GALLERY (outside any form to avoid nested forms) -->
    <div class="gallery" th:if="${mode=='edit' and images != null and !images.isEmpty()}">
        <div class="grid">
            <div class="img-card" th:each="img : ${images}">
                <img class="thumb" th:src="@{${img.image}}" alt="image"/>

                <!-- Delete (standalone form) -->
                <form th:action="@{/branded-medicines/{bmId}/images/{imageId}/delete(bmId=${bm.id},imageId=${img.id})}"
                      method="post" style="position:absolute;top:6px;right:6px;">
                    <button type="submit" class="icon-btn" title="Remove">Ã—</button>
                </form>

                <!-- Main badge or Set as main (standalone form) -->
                <div th:if="${img.mainImage}" class="chip">Main</div>
                <form th:if="${!img.mainImage}"
                      th:action="@{/branded-medicines/{bmId}/images/{imageId}/set-main(bmId=${bm.id},imageId=${img.id})}"
                      method="post" style="margin-top:8px;text-align:center;">
                    <button type="submit" class="small-btn">Set as main</button>
                </form>
            </div>
        </div>
    </div>

</div>
</body>
</html>
